/****************************************************************************/
/*   TITLE              Hangul Library <HAN> 4.1                            */
/*   SUB-TITLE          hanja_to_hangul(), hangul_to_hanja()                */
/*   FILENAME           korchi.c                                            */
/*   DATE & TIME        05/10/92(SUN) 18:00                                 */
/*   PROGRAMMER         Lee Hyun-Ho (ID:easyride)                           */
/****************************************************************************/

#include <stdio.h>
#include <dos.h>
#include "hanio.h"

/****************************************************************************/
/*                             Macro Constants                              */
/****************************************************************************/

#define mini            unsigned char
#define HANJA_FONT_FILE "hanja.fnt"

/****************************************************************************/
/*                             Static Variables                             */
/****************************************************************************/

/* hangul code for 473 hangul */
static unsigned hangul_code[473] =
{
   0x8861,0x8862,0x8865,0x8869,0x8871,0x8873,0x8877,0x8881,
   0x8882,0x8897,0x88a2,0x88e1,0x88e5,0x88e9,0x88f1,0x88f3,
   0x8941,0x8962,0x8965,0x8969,0x8971,0x8977,0x8981,0x89a1,
   0x89a2,0x89a5,0x89a9,0x89b7,0x89b8,0x89c1,0x89c2,0x89c5,
   0x89c9,0x89d7,0x89e1,0x8a41,0x8a57,0x8a61,0x8a81,0x8a82,
   0x8a85,0x8a89,0x8a97,0x8aa5,0x8aa9,0x8ac1,0x8ae1,0x8b41,
   0x8b45,0x8b49,0x8b62,0x8b65,0x8b69,0x8b71,0x8b73,0x8b77,
   0x8ba1,0x8ba5,0x8ba9,0x8bb1,0x8fa2,0x9061,0x9062,0x9065,
   0x9069,0x9071,0x9073,0x9077,0x9081,0x9097,0x9161,0x9165,
   0x9171,0x9177,0x91a1,0x91a2,0x91a5,0x91b7,0x9241,0x9261,
   0x9281,0x9285,0x9289,0x9341,0x9362,0x9371,0x9377,0x93a1,
   0x93a2,0x9461,0x9465,0x9469,0x9471,0x9473,0x9477,0x9481,
   0x9482,0x94e2,0x95a1,0x95a2,0x95a5,0x95a9,0x95b7,0x9681,
   0x9685,0x9762,0x9777,0x9c61,0x9c62,0x9c65,0x9c69,0x9c71,
   0x9c73,0x9c77,0x9c81,0x9c97,0x9ca2,0x9cb7,0x9d61,0x9d62,
   0x9d65,0x9d69,0x9d71,0x9d73,0x9d77,0x9d81,0x9da1,0x9da2,
   0x9da5,0x9db7,0x9e41,0x9e61,0x9e77,0x9e81,0x9f41,0x9f42,
   0x9f45,0x9f49,0x9f57,0x9f62,0x9f71,0x9f77,0x9fa1,0x9fa5,
   0x9fb1,0x9fb3,0xa061,0xa062,0xa065,0xa069,0xa077,0xa081,
   0xa082,0xa097,0xa162,0xa165,0xa169,0xa177,0xa181,0xa1a1,
   0xa1a2,0xa1a9,0xa1b7,0xa261,0xa281,0xa282,0xa285,0xa289,
   0xa3a1,0xa3a5,0xa3a9,0xa462,0xa465,0xa469,0xa477,0xa481,
   0xa482,0xa4e5,0xa4e9,0xa4f1,0xa4f3,0xa562,0xa565,0xa569,
   0xa577,0xa5a1,0xa5a2,0xa5a5,0xa5a9,0xa5b7,0xa681,0xa682,
   0xa685,0xa689,0xa697,0xa7a1,0xa7a5,0xa7b7,0xac61,0xac62,
   0xac65,0xac69,0xac71,0xac73,0xac77,0xac81,0xac82,0xac97,
   0xace1,0xace2,0xace5,0xace9,0xacf1,0xacf3,0xacf7,0xad41,
   0xada1,0xada2,0xada5,0xada9,0xadb7,0xade1,0xae41,0xae81,
   0xae82,0xae85,0xae89,0xae97,0xaf69,0xaf73,0xaf77,0xafa1,
   0xafa2,0xafa5,0xafa9,0xafb1,0xafb3,0xb077,0xb3a1,0xb461,
   0xb462,0xb465,0xb469,0xb471,0xb473,0xb477,0xb481,0xb482,
   0xb497,0xb4a1,0xb4a2,0xb4b7,0xb4e1,0xb4e2,0xb4e5,0xb4e9,
   0xb4f1,0xb4f3,0xb545,0xb561,0xb562,0xb565,0xb569,0xb571,
   0xb573,0xb577,0xb581,0xb5a1,0xb5a2,0xb5a5,0xb5a9,0xb5b7,
   0xb5c1,0xb5c5,0xb5c9,0xb5d7,0xb5e1,0xb641,0xb661,0xb662,
   0xb677,0xb681,0xb682,0xb685,0xb689,0xb697,0xb6a5,0xb6a9,
   0xb6e1,0xb741,0xb742,0xb745,0xb749,0xb757,0xb765,0xb769,
   0xb771,0xb773,0xb777,0xb781,0xb7a1,0xb7a2,0xb7a5,0xb7a9,
   0xb7b1,0xb7b3,0xb7b7,0xb861,0xb862,0xb865,0xb871,0xb873,
   0xb877,0xb881,0xb897,0xb8e1,0xb8e2,0xb8e5,0xb8e9,0xb8f1,
   0xb8f3,0xb8f7,0xb941,0xb9a1,0xb9a2,0xb9a5,0xb9a9,0xb9b7,
   0xb9c1,0xba41,0xba81,0xba82,0xba85,0xba89,0xba97,0xbb62,
   0xbb69,0xbb73,0xbb77,0xbba1,0xbba2,0xbba5,0xbba9,0xbbb1,
   0xbbb3,0xbbb7,0xc061,0xc062,0xc065,0xc069,0xc071,0xc077,
   0xc081,0xc082,0xc0e1,0xc0e2,0xc0e5,0xc0e9,0xc0f1,0xc0f3,
   0xc0f7,0xc141,0xc1a1,0xc1a2,0xc1a5,0xc1b7,0xc1c9,0xc241,
   0xc281,0xc282,0xc285,0xc289,0xc297,0xc2c1,0xc2e1,0xc362,
   0xc377,0xc3a1,0xc3a2,0xc3a5,0xc3a9,0xc3b1,0xc3b3,0xc3b7,
   0xc5e1,0xc861,0xc862,0xc865,0xc869,0xc871,0xc873,0xc877,
   0xc881,0xc882,0xc897,0xc8e1,0xc9a1,0xc9b7,0xca41,0xca81,
   0xcb62,0xcc61,0xcb77,0xcc65,0xcc69,0xcc81,0xcc97,0xcca2,
   0xcd65,0xcd71,0xcd77,0xcd81,0xcda1,0xcda2,0xce61,0xce91,
   0xce97,0xcfa1,0xcfa9,0xcfb3,0xd061,0xd062,0xd065,0xd069,
   0xd071,0xd073,0xd077,0xd081,0xd082,0xd097,0xd0b7,0xd0e1,
   0xd0e5,0xd0e9,0xd0f1,0xd162,0xd165,0xd169,0xd171,0xd173,
   0xd177,0xd181,0xd1a1,0xd1a2,0xd1a5,0xd1a9,0xd1b7,0xd1c1,
   0xd1c2,0xd1c5,0xd1c9,0xd1d7,0xd241,0xd242,0xd257,0xd261,
   0xd281,0xd285,0xd297,0xd2a5,0xd2c1,0xd2e1,0xd341,0xd349,
   0xd357,0xd362,0xd365,0xd369,0xd371,0xd373,0xd377,0xd381,
   0xd3a9
};

/* index for hanja in hanja font file */
static unsigned hanja_index[474] =
{
   0x0000,0x001d,0x0028,0x0040,0x004a,0x005e,0x0064,0x007c,
   0x0090,0x0092,0x0096,0x0097,0x00a8,0x00b4,0x00b8,0x00bf,
   0x00c2,0x00c5,0x00cc,0x00d7,0x00dd,0x00e3,0x0110,0x0128,
   0x014f,0x0156,0x0160,0x0163,0x0173,0x0174,0x0180,0x0184,
   0x0195,0x0199,0x01a6,0x01a9,0x01b2,0x01b6,0x01cf,0x0205,
   0x020b,0x0211,0x0215,0x021b,0x0225,0x022a,0x0230,0x0236,
   0x0245,0x024c,0x024d,0x0254,0x0263,0x0264,0x0272,0x0279,
   0x027d,0x02bd,0x02be,0x02c2,0x02c3,0x02c4,0x02d3,0x02db,
   0x02e4,0x02e6,0x02ef,0x02f4,0x02fb,0x0301,0x0302,0x0303,
   0x0306,0x030a,0x030c,0x031e,0x0324,0x0325,0x032c,0x0332,
   0x0333,0x033b,0x033c,0x033d,0x033f,0x0341,0x0342,0x0348,
   0x034a,0x034c,0x034e,0x0362,0x0367,0x0378,0x037d,0x0388,
   0x0398,0x0399,0x039b,0x03c3,0x03cd,0x03d7,0x03d9,0x03ea,
   0x03f5,0x03fb,0x03fc,0x0405,0x040e,0x0417,0x0420,0x0422,
   0x042c,0x042f,0x0437,0x043b,0x043d,0x043e,0x044b,0x045d,
   0x0464,0x0470,0x0476,0x047b,0x047c,0x048e,0x0493,0x04a5,
   0x04ac,0x04ad,0x04b4,0x04bc,0x04c8,0x04c9,0x04d6,0x04e4,
   0x04e7,0x04ed,0x04f1,0x04f2,0x04f4,0x04f5,0x04fb,0x0515,
   0x051e,0x0523,0x0527,0x052f,0x0535,0x0548,0x054f,0x055b,
   0x0569,0x056e,0x0574,0x0576,0x0581,0x0583,0x0592,0x0593,
   0x05ab,0x05b2,0x05b4,0x05b7,0x05c3,0x05d9,0x05db,0x05e7,
   0x05ea,0x05fd,0x060a,0x060d,0x0620,0x0639,0x0644,0x0660,
   0x0674,0x067c,0x0686,0x068a,0x0693,0x0695,0x06a0,0x06a7,
   0x06ab,0x06bc,0x06cc,0x06dd,0x06de,0x06df,0x06ef,0x071a,
   0x071b,0x072e,0x0733,0x0739,0x0764,0x0772,0x0776,0x07b2,
   0x07b6,0x07c2,0x07c7,0x07cf,0x07d3,0x07f2,0x07f5,0x07fa,
   0x07ff,0x081d,0x082c,0x084c,0x0859,0x0861,0x0865,0x0877,
   0x0880,0x08a5,0x08ae,0x08b4,0x08b5,0x08bd,0x08c2,0x08c4,
   0x0901,0x090d,0x0928,0x092c,0x092f,0x0932,0x0937,0x0941,
   0x095d,0x096c,0x0984,0x0988,0x0992,0x0995,0x0996,0x0997,
   0x09a9,0x09b7,0x09c1,0x09c5,0x09cd,0x09d1,0x09d8,0x09e3,
   0x09ea,0x09ee,0x09f9,0x0a02,0x0a21,0x0a2b,0x0a30,0x0a36,
   0x0a38,0x0a3e,0x0a40,0x0a41,0x0a59,0x0a66,0x0a91,0x0a9b,
   0x0aaa,0x0aae,0x0ad6,0x0aee,0x0b0c,0x0b11,0x0b17,0x0b18,
   0x0b21,0x0b29,0x0b3b,0x0b3c,0x0b41,0x0b45,0x0b4a,0x0b70,
   0x0b76,0x0b8e,0x0bae,0x0bb7,0x0bc4,0x0bc7,0x0bc9,0x0be4,
   0x0be7,0x0c00,0x0c38,0x0c3f,0x0c4c,0x0c51,0x0c56,0x0c5d,
   0x0c5e,0x0c64,0x0c67,0x0c6b,0x0c7e,0x0ca4,0x0cac,0x0cc4,
   0x0ccd,0x0cd8,0x0cdd,0x0ce1,0x0cfb,0x0d08,0x0d0d,0x0d13,
   0x0d14,0x0d39,0x0d4a,0x0d4e,0x0d6a,0x0d83,0x0dac,0x0db4,
   0x0dbd,0x0dc0,0x0df7,0x0e0e,0x0e3c,0x0e40,0x0e42,0x0e45,
   0x0e56,0x0e5b,0x0e5c,0x0e84,0x0e86,0x0e99,0x0e9a,0x0e9e,
   0x0e9f,0x0ea0,0x0ea3,0x0eae,0x0ed0,0x0ed5,0x0ef8,0x0f07,
   0x0f09,0x0f10,0x0f13,0x0f22,0x0f29,0x0f38,0x0f3d,0x0f47,
   0x0f5d,0x0f69,0x0f6d,0x0f71,0x0f80,0x0f93,0x0f9d,0x0fa7,
   0x0fb1,0x0fb9,0x0fc3,0x0fde,0x0fe4,0x0fe8,0x0ff2,0x0ff3,
   0x0ff6,0x100d,0x1019,0x101c,0x101f,0x1025,0x1028,0x1037,
   0x103c,0x103d,0x1055,0x1058,0x1059,0x105c,0x1065,0x1066,
   0x1068,0x1069,0x1077,0x1087,0x1091,0x1093,0x1097,0x109a,
   0x109f,0x10ad,0x10b0,0x10b1,0x10b2,0x10b6,0x10bd,0x10c3,
   0x10c9,0x10cb,0x10cc,0x10dc,0x10e5,0x10e8,0x10f3,0x10f7,
   0x10f8,0x1102,0x1103,0x1108,0x1112,0x112e,0x1134,0x1142,
   0x1144,0x1149,0x1150,0x115a,0x115c,0x116a,0x116f,0x117d,
   0x117f,0x118b,0x1192,0x11a3,0x11b5,0x11b7,0x11bc,0x11c5,
   0x11c9,0x11cd,0x11ce,0x11d0,0x11d4,0x11e9,0x11ed,0x11ee,
   0x11fa,0x120e,0x1217,0x1240,0x1243,0x1249,0x124c,0x1256,
   0x1264,0x126a,0x127b,0x1280,0x1298,0x12ac,0x12ae,0x12b1,
   0x12be,0x12cb,0x12d5,0x12d6,0x12da,0x12dd,0x12e5,0x12ea,
   0x12ed,0x12f2,0x12f3,0x12f7,0x12fb,0x12fe,0x1302,0x1303,
   0x1317,0x1318
};

/****************************************************************************/
/*                            External Variables                            */
/****************************************************************************/

extern unsigned hanja_buff_ptr;

/****************************************************************************/
/*                 Implementation of the library functions                  */
/****************************************************************************/

void hanja_to_hangul(mini *source, mini *dest)
/* get a hangul code for the hanja, source */
{
   unsigned index, low = 0, mid, high = 472;

   if(source[0] >= 0xe0)
   {
      index = (source[0] & 0x1f) * 188 + (source[1] < 0x91 ? source[1] - 0x31
							   : source[1] - 0x43);
      while(1)
      {
	 mid = (high + low) >> 1;
	 if(hanja_index[mid] == index || low > high)
	 {
	    dest[0] = (mini) (hangul_code[mid] >> 8);
	    dest[1] = (mini) (hangul_code[mid] & 0x00ff);
	    dest[2] = 0;
	    return;
	 }
	 else if(hanja_index[mid] > index)
         {
            high = mid;
            high--;
         }
	 else
         {
            low = mid;
            low++;
         }
      }
   }
   else if(source[0] & 0x80)
   {
      dest[0] = source[0];
      dest[1] = source[1];
      dest[2] = 0;
   }
   else
   {
      dest[0] = source[0];
      dest[1] = 0;
   }
}

int hangul_to_hanja(mini *string)
/* read hanja code for hangul <string> to hanja buffer -- internal function */
{
   unsigned low = 0, mid, high = 472;
   unsigned code;
   FILE *stream;
   long fp;
   int  hanja_num, read_hanja, i;

   code = ((unsigned) string[0] << 8) | string[1];
   read_hanja = 0;
   while(low <= high)
   {
      mid = (high + low) >> 1;
      if(hangul_code[mid] == code)
      {
	 hanja_num = hanja_index[mid + 1] - hanja_index[mid];
	 if((stream = fopen(HANJA_FONT_FILE, "rb")) == NULL) return 0;
	 fp = (long) hanja_index[mid] << 5;
	 fseek(stream, fp, SEEK_SET);
	 for(i = 0; i < hanja_num; i++)
	 {
	    if(fread(hanja_buff[hanja_buff_ptr].font, HAN_FONT_SIZE, 1, stream) == 1)
	    {
	       code =   (hanja_index[mid] + i) / 188 + 0xe0;
	       code <<= 8;
	       code |=  (hanja_index[mid] + i) % 188;
	       if((code & 0x00ff) < 78)
		  code += 0x31;
	       else
		  code += 0x91 - 78;
	       hanja_buff[hanja_buff_ptr].code = code;
	       hanja_buff_ptr = (hanja_buff_ptr + 1) % hanja_buff_size;
	       read_hanja++;
	    }
	    else
	       break;
	 }
	 fclose(stream);
	 break;
      }
      else if(hangul_code[mid] > code)
      {
         high = mid;
         high--;
      }
      else
      {
         low = mid;
         low++;
      }
   }

   return(read_hanja);
}

